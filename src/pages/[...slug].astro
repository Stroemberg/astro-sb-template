---
import {
	useStoryblokApi,
	getLiveStory,
	type ISbStoryData,
	type SbBlokData,
} from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import Layout from '../layouts/Layout.astro';
import generateStaticPaths from '../utils/generateStaticPaths';
import type {
	StoryblokGlobal,
	StoryblokPage,
} from '../../.storyblok/types/288498216560234/storyblok-components';

const isLivePreview =
	import.meta.env.DEV || import.meta.env.STORYBLOK_LIVE_PREVIEW === 'true';

type StoryblokApiResponse<T> = {
	data: {
		story: ISbStoryData<T>;
		status: number | undefined;
	};
};

export async function getStaticPaths() {
	return await generateStaticPaths();
}
const { slug } = Astro.params;

const storyblokApi = useStoryblokApi();

const { data } = (await storyblokApi
	.get(`cdn/stories/${slug || 'home'}`, {
		version: isLivePreview ? 'draft' : 'published',
	})
	.catch((error) => {
		return { data: { status: error.response.status } };
	})) as StoryblokApiResponse<StoryblokPage>;

if (data.status === 404) {
	return Astro.redirect('/404');
}

const { data: globalData } = await storyblokApi.getStory('global', {
	version: isLivePreview ? 'draft' : 'published',
});

const story = data.story;
const liveStory = isLivePreview ? await getLiveStory(Astro) : null;
---

<Layout
	global={globalData.story.content as StoryblokGlobal}
	seo={story.content.seo?.[0]}
>
	<StoryblokComponent
		blok={liveStory?.content || (story.content as SbBlokData)}
	/>
</Layout>
